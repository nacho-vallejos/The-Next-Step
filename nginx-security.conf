# ==========================================
# NGINX SECURITY CONFIGURATION
# ==========================================

server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    
    # Root directory
    root /var/www/html;
    index index.html;
    
    # ==========================================
    # SECURITY HEADERS
    # ==========================================
    
    # X-Frame-Options: Prevent clickjacking
    add_header X-Frame-Options "DENY" always;
    
    # X-Content-Type-Options: Prevent MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # X-XSS-Protection: Enable XSS filter
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer-Policy: Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Content-Security-Policy: Strict CSP
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https://images.unsplash.com data:; media-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;
    
    # Permissions-Policy: Disable unnecessary features
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()" always;
    
    # Remove server information
    server_tokens off;
    more_clear_headers Server;
    more_clear_headers X-Powered-By;
    
    # ==========================================
    # SSL/TLS CONFIGURATION (Uncomment for HTTPS)
    # ==========================================
    
    # listen 443 ssl http2;
    # listen [::]:443 ssl http2;
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;
    
    # SSL protocols and ciphers
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    # ssl_prefer_server_ciphers on;
    # ssl_session_cache shared:SSL:10m;
    # ssl_session_timeout 10m;
    
    # HSTS (HTTP Strict Transport Security)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # OCSP Stapling
    # ssl_stapling on;
    # ssl_stapling_verify on;
    # ssl_trusted_certificate /path/to/chain.pem;
    
    # ==========================================
    # RATE LIMITING
    # ==========================================
    
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;
    limit_req zone=general burst=20 nodelay;
    
    # ==========================================
    # DISABLE UNNECESSARY HTTP METHODS
    # ==========================================
    
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
        return 405;
    }
    
    # ==========================================
    # BLOCK ACCESS TO SENSITIVE FILES
    # ==========================================
    
    # Block hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Block sensitive files
    location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist|orig|save|~|env|git)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Block access to package and config files
    location ~* ^/(README|INSTALL|LICENSE|CHANGELOG|SECURITY|package\.json|package-lock\.json|composer\.json|composer\.lock|tsconfig\.json|jest\.config\.js)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ==========================================
    # MAIN LOCATION BLOCKS
    # ==========================================
    
    location / {
        try_files $uri $uri/ /index.html;
        
        # Enable GZIP compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
    }
    
    # Static assets caching
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Video files caching
    location ~* \.(mp4|webm|ogg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # Enable byte-range requests for video
        add_header Accept-Ranges bytes;
    }
    
    # ==========================================
    # PREVENT HOTLINKING
    # ==========================================
    
    location ~* \.(jpg|jpeg|png|gif|svg|webp|mp4)$ {
        valid_referers none blocked server_names;
        if ($invalid_referer) {
            return 403;
        }
    }
    
    # ==========================================
    # BLOCK SUSPICIOUS USER AGENTS
    # ==========================================
    
    if ($http_user_agent ~* (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader|HTTrack|archiver|email|harvest|extract|grab|miner)) {
        return 403;
    }
    
    # ==========================================
    # BLOCK SQL INJECTION ATTEMPTS
    # ==========================================
    
    if ($args ~* "(union.*select|insert.*into|select.*from|delete.*from|drop.*table)") {
        return 403;
    }
    
    # ==========================================
    # LOGGING
    # ==========================================
    
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
}

# ==========================================
# REDIRECT HTTP TO HTTPS (Uncomment for production)
# ==========================================

# server {
#     listen 80;
#     listen [::]:80;
#     server_name yourdomain.com www.yourdomain.com;
#     return 301 https://$server_name$request_uri;
# }
